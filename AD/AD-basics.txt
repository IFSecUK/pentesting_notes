What is Active Directory?
	-> Directory Service developed by Microsoft to manage Windows domain networks. 
	-> Stores information related to objects, such as computers, Users, PRinters, etc.
		-> Think about it as a phone book for Windows. 
	-> Authenticates using Kerberos tickets.
		-> Non-Windows devices, such as Linux machines, firewalls, etc. can also authenticate to Active Directory via RADIUS or LDAP. 

Why Active Directory?
	-> Active Directory is the most commonly used Identity management service in the world.	
		-> 95% of Fortune 1000 companies implement the service in their networks.
	-> Can be exploited eithout ever attacking patchable exploits.
		-> Instead, we abuse features, trusts, components, and more.


Physical AD components:
	1. Domain Controllers
		-> A DC is a server with the AD DS server role installed that has specifically been promoted to a DC.
		-> Host a copy of the AD DS directory store.
		-> Provide authentication and authorization services.
		-> Replicate updates to other domain controllers in the domain and forest.
		-> Allow administrative access to manage user acounts and network resources.
	2. AD DS Data Store:
		-> The AD DS data store contains the database files and processes that store and manage directory information for users, services and applications.
		-> Consists of the Ntds.dit file - a database that contains all of the information of an Active Directory domain controller as well as password hashes for domain users.
		-> Is stored by default in the %SystemRoot%\NTDS folder on all domain controllers.
		-> Is accessible only through the domain controller processes and protocols.

Logical AD Components:
	1. AD DS Schema:
		-> Defines every type of object that can be stored in the directory.
		-> Enforces rules regarding	object creation and configuration.
		-> It is just like a rule book. You can even say a blueprint.
	2. Domains (Contoso.com):
		-> Domains are used to group and manage objects in an organization.
		-> An administrative boundary for applying policies to groups of objects.
		-> A replication boundary for replicating data between domain controllers.
		-> An authentication and authorization boundary that provides a way to limit the scope of access to resources.
	3. Trees (contoso.com -> emea.contoso.com, na.contoso.com):
		-> A domain tree is a hierarchy of domains in AD DS.
		-> Share a contiguous namespace with a parent domain.
		-> Can have additional child domains.
		-> By default create a two-way transitive trust with other domains.
	4. Forests
		-> A forest is a collection of one or more domain trees.
		-> Share a common scheme
		-> Share a common configuration partition.
		-> Share a common global catalog to enable searching.
		-> Enable trusts between all domains in the forest.
		-> Share the Enterprise Admins and Schema Admins groups.
	5. Organizational Units (Ous):
		-> OUs are Active Directory containers that can contain users, groups, computers and other OUs.
		-> Represent your organization heirarchically and logically.
		-> Manage a collection of objects in a consistent way.
		-> Delegate permissions to administer groups of objects.
		-> Apply policies.
	6. Trusts:
		-> Trusts provide a mechanism for users to gain access to resources in another domain.
		-> Directional: The trust direction flows from trusting domain to the trusted domain.
		-> Transitive: The trust relationship is extended beyond a two-domain trust to include other trusted domains. 
		-> All domains in a forest trust all other domains in the forest.
		-> Trusts can extend outside the forest.
		-> The type of trusts put in place determines how the domains and trees in a forest are able to communicate and send data to and from each other when attacking an Active Directory environment you can sometimes abuse these trusts in order to move laterally throughout the network. 

	7. Objects:
		-> User: Enables network resource access for a user.
		-> InetOrgPerson: -> Similar to a user account.
						  -> Used for compatibility with other directory services.
		-> Contacts: -> Used primarily to assign email-addresses to external users.
					 -> Does not enable network access.
		-> Groups: Used to simplify the administration of access control.
		-> Computers: Enables authentication and auditing of computer access to resources.
		-> PRinters: Used to simplify the process of locating and connecting to printers.
		-> Shared Folders: Enables users to search for shared folders based on properties.

Users + Groups:
	-> There are four main types of users you'll find in an Active Directory network; however, there can be more depending on how a company manages the permissions of its users. The four types of users are: 
		1. Domain Admins - This is the big boss: they control the domains and are the only ones with access to the domain controller.
		2. Service Accounts (Can be Domain Admins) - These are for the most part never used except for service maintenance, they are required by Windows for services such as SQL to pair a service with a service account
			Note: Service accounts should never be domain admins.
		3. Local Administrators - These users can make changes to local machines as an administrator and may even be able to control other normal users, but they cannot access the domain controller
		4. Domain Users - These are your everyday users. They can log in on the machines they have the authorization to access and may have local administrator rights to machines depending on the organization.

	-> Groups make it easier to give permissions to users and objects by organizing them into groups with specified permissions. There are two overarching types of Active Directory groups: 

	    1. Security Groups - These groups are used to specify permissions for a large number of users
	    2. Distribution Groups - These groups are used to specify email distribution lists. As an attacker these groups are less beneficial to us but can still be beneficial in enumeration

	Default Security Groups:
		Domain Controllers - All domain controllers in the domain
		Domain Guests - All domain guests
		Domain Users - All domain users
		Domain Computers - All workstations and servers joined to the domain
		Domain Admins - Designated administrators of the domain
		Enterprise Admins - Designated administrators of the enterprise
		Schema Admins - Designated administrators of the schema
		.
		.
		.

Domain Policies Overview:
	-> They simply act as a rulebook for Active  Directory that a domain admin can modify and alter as they deem necessary to keep the network running smoothly and securely. Along with the very long list of default domain policies, domain admins can choose to add in their own policies not already on the domain controller, for example: if you wanted to disable windows defender across all machines on the domain you could create a new group policy object to disable Windows Defender. 

Domain Services Overview:
	-> Domain Services are exactly what they sound like. They are services that the domain controller provides to the rest of the domain or tree. There is a wide range of various services that can be added 	to a domain controller.

	1. LDAP - Lightweight Directory Access Protocol; provides communication between applications and directory services
    2. Certificate Services - allows the domain controller to create, validate, and revoke public key certificates
    3. DNS, LLMNR, NBT-NS - Domain Name Services for identifying IP hostnames

Domain Authentication Overview:
	-> The most important part of Active Directory -- as well as the most vulnerable part of Active Directory -- is the authentication protocols set in place. There are two main types of authentication in place for Active Directory: NTLM and Kerberos.

	1. Kerberos - The default authentication service for Active Directory uses ticket-granting tickets and service tickets to authenticate users and give users access to other resources across the domain.
    2. NTLM - default Windows authentication protocol uses an encrypted challenge/response protocol

AD in the Cloud:
	Azure AD Overview:
		-> Azure acts as the middle man between your physical Active Directory and your users' sign on. This allows for a more secure transaction between domains, making a lot of Active Directory attacks ineffective.

	Cloud Security Overview:
		-> The best way to show you how the cloud takes security precautions past what is already provided with a physical network is to show you a comparison with a cloud Active Directory environment: 
		Windows Server AD	Azure AD
				LDAP		Rest APIs
				NTLM		OAuth/SAML
				Kerberos	OpenID
				OU Tree		Flat Structure
		Domains and Forests	Tenants
				Trusts		Guests


creating a service
>setspn -a HYDRA-DC/SQLService.MARVEL.local:60111 MARVEL\SQLService

setting a service:
>setspn -T MARVEL.local -Q */*